# Announcer for Avalon (KMP Scaffold)

Kotlin Multiplatform app scaffold for an Avalon narrator with:
- Shared Compose UI (Android + iOS)
- Typed Kotlin role catalog, clip IDs, and narration rules (no JSON manifests)
- Bundled selectable voice packs with default-pack fallback for missing clips
- Real platform playback adapters (`ExoPlayer` on Android, `AVAudioPlayer` on iOS)
- Setup validation warnings, run generation, and playback controls
- Local persistence of last setup/settings

## Structure

- `composeApp/src/commonMain/kotlin/com/avalonnarrator/domain` typed roles, clips, setup models
- `composeApp/src/commonMain/kotlin/com/avalonnarrator/engine` DSL rules, planner, validator
- `composeApp/src/commonMain/kotlin/com/avalonnarrator/playback` resolver/player contracts + implementation
- `composeApp/src/commonMain/kotlin/com/avalonnarrator/ui` setup/settings/narrator screens
- `composeApp/src/commonMain/resources` bundled assets (`audio/<voice_pack_id>`, `images/characters`, `fonts`)

## Asset Conventions

- Character image path: `composeApp/src/commonMain/composeResources/drawable/<image_key>.png`
- Audio path: `audio/<voice_pack_id>/<clip_id>.mp3` under `composeApp/src/commonMain/resources`
- Android build maps `src/commonMain/resources` into app assets automatically.

Voice pack mapping is defined in Kotlin at:
- `composeApp/src/commonMain/kotlin/com/avalonnarrator/domain/audio/VoicePackCatalog.kt`

Voice pack registry source-of-truth is:
- `scripts/voice_packs.json`

Generate/sync voice pack catalog and clips with:
- `python3 scripts/generate_voice_pack.py --sync-only`
- `python3 scripts/generate_voice_pack.py --pack-id <id> --display-name "<Name>" --description "<desc>" --voice-id <elevenlabs_voice_id>`

Notes:
- `VoicePackCatalog.kt` is auto-generated by the script.
- Set `ELEVENLABS_API_KEY` before clip generation.
- New clips are written to `composeApp/src/commonMain/resources/audio/<asset_dir>/`.

## Commands

- Compile common shared code:
  - `./gradlew :composeApp:compileCommonMainKotlinMetadata`
- Run iOS simulator tests:
  - `./gradlew :composeApp:iosSimulatorArm64Test`
- Build iOS app host for Simulator (from the new `iosApp` Xcode project):
  - `xcodebuild -project iosApp/iosApp.xcodeproj -scheme iosApp -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.1' -configuration Debug build`
- Android compile requires local Android SDK configured (`ANDROID_HOME` or `local.properties`).

## iOS App Host

- Xcode project path: `iosApp/iosApp.xcodeproj`
- The host app embeds the KMP framework by running:
  - `./gradlew :composeApp:embedAndSignAppleFrameworkForXcode`
  from an Xcode build phase.
- Swift entry point uses shared Compose UI via:
  - `MainViewControllerKt.MainViewController()`
